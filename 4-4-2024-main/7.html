<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Registration</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!--data tables css cdn automatically styles table -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.css">
  <style>
    .error {
      color: red;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h1 style="text-align: center">User Registration</h1>


    <form id="registrationForm">
      <div class="form-group">
        <label for="fname"><strong>First Name</strong></label>
        <input type="text" class="form-control" id="fname" name="fname" />
      </div>

      <div class="form-group">
        <label for="lname"><strong>Last Name</strong></label>
        <input type="text" class="form-control" id="lname" name="lname" />
      </div>

      <div class="form-group">
        <strong>Course</strong><br>
        <div class="row">
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="coursePhysics" name="courses" value="Physics">
              <label class="form-check-label" for="coursePhysics">Physics</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="courseChemistry" name="courses" value="Chemistry">
              <label class="form-check-label" for="courseChemistry">Chemistry</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="courseMaths" name="courses" value="Maths">
              <label class="form-check-label" for="courseMaths">Maths</label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="courseEnglish" name="courses" value="English">
              <label class="form-check-label" for="courseEnglish">English</label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="dateOfBirth"><strong>Date of Birth</strong></label>
        <input type="date" class="form-control" id="dateOfBirth" name="dateOfBirth" min="1900-01-01" />
      </div>

      <!-- new code -->
      <div class="form-group">
        <strong>Gender</strong>
        <div id="gender">
          <input type="radio" id="genderMale" name="gender" value="Male">
          <label for="genderMale">Male</label>
          <input type="radio" id="genderFemale" name="gender" value="Female">
          <label for="genderFemale">Female</label>
          <input type="radio" id="genderOther" name="gender" value="Other">
          <label for="genderOther">Other</label>
        </div>
      </div>
      <!---->

      <div class="form-group">
        <label for="state"><strong>State</strong></label>
        <select class="form-control" id="state" name="state">
          <option value="">Select a State</option>
          <option value="Andhra Pradesh">Andhra Pradesh</option>
          <option value="Arunachal Pradesh">Arunachal Pradesh</option>
          <option value="Assam">Assam</option>
          <option value="Bihar">Bihar</option>
          <option value="Chhattisgarh">Chhattisgarh</option>
          <option value="Goa">Goa</option>
          <option value="Gujarat">Gujarat</option>
          <option value="Haryana">Haryana</option>
          <option value="Himachal Pradesh">Himachal Pradesh</option>
          <option value="Jharkhand">Jharkhand</option>
          <option value="Karnataka">Karnataka</option>
          <option value="Kerala">Kerala</option>
          <option value="Madhya Pradesh">Madhya Pradesh</option>
          <option value="Maharashtra">Maharashtra</option>
          <option value="Manipur">Manipur</option>
          <option value="Meghalaya">Meghalaya</option>
          <option value="Mizoram">Mizoram</option>
          <option value="Nagaland">Nagaland</option>
          <option value="Odisha">Odisha</option>
          <option value="Punjab">Punjab</option>
          <option value="Rajasthan">Rajasthan</option>
          <option value="Sikkim">Sikkim</option>
          <option value="Tamil Nadu">Tamil Nadu</option>
          <option value="Telangana">Telangana</option>
          <option value="Tripura">Tripura</option>
          <option value="Uttar Pradesh">Uttar Pradesh</option>
          <option value="Uttarakhand">Uttarakhand</option>
          <option value="West Bengal">West Bengal</option>
        </select>
      </div>


      <div class="form-group">
        <label for="phone"><strong>Phone</strong></label>
        <input type="tel" class="form-control" id="phone" name="phone" pattern="[0-9]{10}" />
      </div>

      <div class="form-group">
        <label for="email"><strong>Email</strong></label>
        <input type="email" class="form-control" id="email" name="email" />
      </div>

      <div class="form-group">
        <label for="comments"><strong>Comments</strong></label>
        <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
      </div>

      <div class="form-group">
        <label for="fileUpload"><strong>Upload File</strong></label>
        <input type="file" class="form-control-file" id="fileUpload" name="fileUpload" accept=".jpg, .jpeg .webp" />
      </div>

      <div class="form-group">
        <label for="password"><strong>Password</strong></label>
        <input type="password" class="form-control" id="password" name="password" />
      </div>

      <div class="form-group">
        <label for="confirmPassword"><strong>Re-enter Password</strong></label>
        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" />
      </div>

      <div id="message" class="text-danger"></div><br>


      <div style="display: flex">
        <button type="submit" class="btn btn-primary" id="registerButton"
          style="margin-right: 5px; width: 100px;">Register</button>
        <button type="button" class="btn btn-success" id="saveChangesButton"
          style="display: none; margin-right: 5px; width: 100px;">Save</button>
        <button type="button" class="btn btn-secondary" id="resetButton"
          style="margin-right: 5px; width: 100px;">Reset</button>
      </div>
    </form>

    <hr />

    <img id="preview" style="display: block; max-width: 100%; max-height: 400px; margin: 0 auto;" />

    <hr />


    <h2 style="text-align: center">Registered Users</h2>

    <table id="userTable" class="table table-striped" style="width:100%">
      <thead>
        <tr>
          <th>Id No</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Course</th>
          <th>Gender</th>
          <th>Date of Birth</th>
          <th>State</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Comments</th>
          <th>File</th>
          <th>Last Updated</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table body content will be inserted dynamically -->
      </tbody>
    </table>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
      crossorigin="anonymous"></script>

    <!-- jquery validator -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <script>
      $(document).ready(function () {
        $('#registrationForm').validate({
          rules: {
            fname: {
              required: true
            },
            lname: {
              required: true
            },
            course: {
              required: true
            },
            gender: {
              required: true
            },
            dateOfBirth: {
              required: true
            },
            state: {
              required: true
            },
            phone: {
              required: true
            },
            email: {
              required: true,
              email: true
            },
            comments: {
              required: true
            },
            password: {
              required: true
            },
            confirmPassword: {
              required: true,
              equalTo: "#password"
            }
          },
          messages: {
            fname: {
              required: 'Please enter your first name'
            },
            lname: {
              required: 'Please enter your last name'
            },
            course: {
              required: 'Please select a course'
            },
            gender: {
              required: 'Please select your gender'
            },
            dateOfBirth: {
              required: 'Please enter your date of birth'
            },
            state: {
              required: 'Please select a state'
            },
            phone: {
              required: 'Please enter your phone number',
              pattern: 'Please enter a valid phone number'
            },
            email: {
              required: 'Please enter your email address',
              email: 'Please enter a valid email address'
            },
            password: {
              required: 'Please enter a password'
            },
            confirmPassword: {
              required: 'Please re-enter your password',
              equalTo: 'Passwords do not match'
            }
          },
          errorElement: 'div',
          errorPlacement: function (error, element) {
            if (element.attr("name") == "gender") {
              error.appendTo(element.closest("#gender"));
            } else {
              error.addClass('error');
              error.insertAfter(element);
            }
          }
        });
      });
    </script>

    <!-- date limiter script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const dateOfBirthInput = document.getElementById("dateOfBirth");
        // Get tomorrow's date
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        // Format tomorrow's date as "YYYY-MM-DD"
        const tomorrowFormatted = tomorrow.toISOString().split("T")[0];
        // Set the max attribute of the date input to tomorrow's date
        dateOfBirthInput.max = tomorrowFormatted;
      });
    </script>

    <!-- data table initialization -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/2.0.3/js/dataTables.min.js"></script>
    <script>
      $(document).ready(function () {
        $('#userTable').DataTable();
      });
    </script>

    <!-- Delete User Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Confirm Deletion
            </h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this user?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteUser" data-bs-dismiss="modal">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- gender radio buttosn functiinality -->
    <script>
      $(document).ready(function () {
        const Gender = $("#gender");
        $("input[type='radio']").change(function () {
          const selectedGender = $("input[name='gender']:checked").val();
          Gender.val(selectedGender);
        });
      });
    </script>
    <!---->

    <script>
      let users = [];
      let idNumber = 1;

      const drawTable = (user) => {
        const table = $('#userTable').DataTable(); // Initialize DataTable
        const dob = new Date(user.dateOfBirth);
        const formattedDOB = `${dob.getMonth() + 1}/${dob.getDate()}/${dob.getFullYear()}`;
        table.row.add([
          user.id,
          user.fname,
          user.lname,
          user.course,
          user.gender,
          user.dateOfBirth,
          user.state,
          user.phone,
          user.email,
          user.comments,
          `<button class="btn btn-primary toggleImage" data-userid="${user.id}">View</button>`,
          user.lastUpdated = new Date().toLocaleString(),
          `<button class="btn btn-sm btn-primary editUser" data-userid="${user.id}">Edit</button>
        <button class="btn btn-sm btn-danger deleteUser" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-userid="${user.id}">Delete</button>`
        ]).draw(false); // Redraw the table without changing the paging
        idNumber++;
      };

      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("toggleImage")) {
          const userId = parseInt(event.target.getAttribute("data-userid"));
          const image = users.find((user) => user.id === userId).file;
          const preview = document.getElementById("preview");
          // If the preview is already displaying the image and belongs to the same user, hide it
          if (preview.src === image) {
            preview.src = ""; // Hide the image
            event.target.innerText = "View"; // Change button text to "View"
          } else {
            // If the preview is not displaying the image, display it
            preview.src = image;
            event.target.innerText = "Hide"; // Change button text to "Hide"
          }
        }
      });

      document.getElementById("resetButton").addEventListener("click", () => {
        document.getElementById("registrationForm").reset();
        $('#registrationForm').find('.error').html('');
        document.getElementById("dateOfBirth").style.color = "black";
        document.getElementById("fileUpload").style.color = "black";
        document.getElementById("registerButton").style.display = "block";
        document.getElementById("saveChangesButton").style.display = "none";
        document.getElementById("resetButton").style.display = "block";
      });

      $(document).ready(function () {
        $("#registrationForm").on("submit", function (event) {
          event.preventDefault();
          if ($(this).valid()) {
            const newUser = {
              id: users.length + 1,
              fname: $("#fname").val(),
              lname: $("#lname").val(),
              course: $("input[name='courses']:checked").map(function () {
                return this.value;
              }).get().join(", "),
              gender: $("#gender").val(),
              dateOfBirth: $("#dateOfBirth").val(),
              state: $("#state").val(),
              phone: $("#phone").val(),
              email: $("#email").val(),
              comments: $("#comments").val(),
              file: "",
              fileName: "",
            };

            // upload file
            const file = $('#fileUpload')[0].files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                newUser.file = e.target.result; // Store the file content
                newUser.fileName = file.name;
              };
              reader.readAsDataURL(file); // Read the file as a data URL
            }

            users.push(newUser);
            drawTable(newUser);
            $(this).trigger("reset"); // Reset the form
            $("#message").html("");
            $("#errorMessage1").html("");
            $("#errorMessage2").html("");
            const table = $('#userTable').DataTable();
            const userId = users[0].id;
          }
        });
      });

      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("editUser")) {
          const userId = parseInt(event.target.getAttribute("data-userid"));
          const user = users.find((user) => user.id === userId);
          document.getElementById("fname").value = user.fname;
          document.getElementById("lname").value = user.lname;
          const courses = user.course.split(", ");
          courses.forEach((course) => {
            document.getElementById(`course${course}`).checked = true;
          });
          if (user.gender === "Male") {
            document.getElementById("genderMale").checked = true;
          } else if (user.gender === "Female") {
            document.getElementById("genderFemale").checked = true;
          } else {
            document.getElementById("genderOther").checked = true;
          }
          document.getElementById("dateOfBirth").value = user.dateOfBirth;
          document.getElementById("state").value = user.state;
          document.getElementById("phone").value = user.phone;
          document.getElementById("email").value = user.email;
          document.getElementById("comments").value = user.comments;
          document.getElementById("registerButton").style.display = "none";
          document.getElementById("saveChangesButton").style.display = "block";
          document.getElementById("resetButton").style.display = "block";
          document
            .getElementById("saveChangesButton")
            .setAttribute("data-userid", userId);
        }
      });

      document.getElementById("saveChangesButton").addEventListener("click", (event) => {
        const form = document.getElementById("registrationForm");
        const userId = parseInt(event.target.getAttribute("data-userid"));
        if ($(form).valid()) {
          const table = $('#userTable').DataTable();
          const rowIndex = table.column(0).data().indexOf(userId); // Get the index of the row with the given userId
          const usersIndex = users.findIndex((user) => user.id === userId);
          if (rowIndex !== -1 && usersIndex !== -1) {
            const editedUser = {
              id: userId,
              fname: document.getElementById("fname").value,
              lname: document.getElementById("lname").value,
              course: $("input[name='courses']:checked").map(function () {
                return this.value;
              }).get().join(", "),
              gender: document.querySelector('input[name="gender"]:checked').value,
              dateOfBirth: document.getElementById("dateOfBirth").value,
              state: document.getElementById("state").value,
              phone: document.getElementById("phone").value,
              email: document.getElementById("email").value,
              comments: document.getElementById("comments").value,
              file: "",
              lastUpdated: new Date().toLocaleString()
            };

            const file = $('#fileUpload')[0].files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                editedUser.file = e.target.result;
                editedUser.fileName = file.name;
              };
              reader.readAsDataURL(file);
            }
            else {
              editedUser.file = users[usersIndex].file;
              editedUser.fileName = users[usersIndex].fileName;
            }
            users[usersIndex] = editedUser;
            try {
              const table = $('#dataTable').DataTable();
              const row = table.column(0).data().indexOf(userId);
              const rowIndex = table.rows().indexes()[row];
              table.row(rowIndex).data([
                editedUser.id,
                editedUser.fname,
                editedUser.lname,
                editedUser.course,
                editedUser.gender,
                editedUser.dateOfBirth,
                editedUser.state,
                editedUser.phone,
                editedUser.email,
                editedUser.comments,
                `<button class="btn btn-primary toggleImage" data-userid="${editedUser.id}">View</button>`,
                editedUser.lastUpdated,
                `<button class="btn btn-sm btn-primary editUser" data-userid="${editedUser.id}">Edit</button>
                                 <button class="btn btn-sm btn-danger deleteUser" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-userid="${editedUser.id}">Delete</button>`
              ]).draw(false);
            }
            catch (e) {
              console.error(e);
            }
            form.reset();
            $('#registerButton').show();
            $('#saveChangesButton').hide();
            $('#resetButton').show();
          }
        }
      });

      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("deleteUser")) {
          const userId = parseInt(event.target.getAttribute("data-userid"));
          document
            .getElementById("confirmDeleteUser")
            .setAttribute("data-userid", userId);
        }
      });

      document
        .getElementById("confirmDeleteUser")
        .addEventListener("click", () => {
          const userId = parseInt(
            document
              .getElementById("confirmDeleteUser")
              .getAttribute("data-userid")
          );
          const usersIndex = users.findIndex((user) => user.id === userId);
          if (usersIndex !== -1) {
            users.splice(usersIndex, 1);
            const preview = document.getElementById("preview");
            preview.src = "";
          }

          const table = $('#userTable').DataTable();
          const rowIndex = table.column(0).data().indexOf(userId);

          if (rowIndex !== -1) {
            const preview = document.getElementById("preview");
            preview.src = "";
          }
          table.row(rowIndex).remove().draw(false);
        });

    </script>

</body>

</html>